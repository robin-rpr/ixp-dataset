name: Update IXP Data and Notify Webhook

on:
  schedule:
    # Runs "Every day at 00:00" (see https://crontab.guru)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 5  # Corrected indentation here

      - name: test
        run: echo "test" >> data/ixps.json

      - name: Check for Changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "No changes to data files"
            echo "::set-output name=no_changes::true"
          else
            echo "Changes detected"
            echo "::set-output name=no_changes::false"
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.no_changes == 'false'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Workflow
          author_email: actions@github.com
          message: 'Updating IXPs'
          add: 'data/*.json'

      - name: Get Last Two Commits
        if: steps.check-changes.outputs.no_changes == 'false'
        id: get-commits
        run: |
          echo "LAST_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "SECOND_LAST_COMMIT=$(git rev-parse HEAD~1)" >> $GITHUB_ENV

      - name: Generate Diff
        run: |
          diff=$(git diff $SECOND_LAST_COMMIT $LAST_COMMIT -- data/ixps.json)
          diff="${diff//'%'/'%25'}"        # Escape %
          diff="${diff//$'\n'/'%0A'}"      # Escape newlines
          diff="${diff//$'\r'/'%0D'}"      # Escape carriage returns
          diff="${diff//\\/\\\\}"          # Escape backslashes
          diff="${diff//\"/\\\"}"          # Escape double quotes
          diff="${diff//$'\n'/\\n}"        # Escape newlines
          echo "::set-output name=diff::$diff"

      - name: Send Notification to Mattermost Channel
        run: |
          diff=$(cat diff_output.txt)
          # Escape backslashes, double quotes, and newlines
          
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"\`\`\`diff\n${diff}\n\`\`\`\"}" ${{ secrets.MATTERMOST_WEBHOOK_URL }}

      # Debugging: Print the diff to the GitHub Actions log
      - name: Print Diff
        if: steps.generate-diff.outputs.diff != ''
        run: |
          echo "Diff output:"
          echo "${{ steps.generate-diff.outputs.diff }}"

      - name: Send Notification to Mattermost Channel
        if: steps.check-changes.outputs.no_changes == 'false'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text": "```diff\n${{ steps.generate-diff.outputs.diff }}\n```"}' ${{ secrets.MATTERMOST_WEBHOOK_URL }}
